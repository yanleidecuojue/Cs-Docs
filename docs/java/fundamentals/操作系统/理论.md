#### 一.计算机组成

##### 1.构成

由多个处理器，主存，打印机，键盘，鼠标，显示器，网络接口以及各种输入输出设备构成

内核态(操作系统运行在这里) <=> 用户态(又叫管态/核心态)

##### 2.CPU

通用寄存器

程序计数器(program counter)

堆栈指针(stack pointer)：包含输入过程中的有关参数，局部变量以及没有保存在寄存器中的临时变量

PSW(program status word，程序状态字寄存器)：程序状态字寄存器是由操作系统维护的8个字节(64位) long 类型的数据集合。它会跟踪当前系统的状态，除非发生系统结束，否则我们可以忽略PSW。用户程序通常可以读取整个PSW，但通常只能写入其某些字段，PSW在系统调用和I/O中起着重要作用。

为了提升性能，CPU设计人员早就放弃了同时去读取，解码和执行一条简单的指令。许多现代的CPU都具有同时读取多条指令的机制。例如，一个CPU可能会有单独访问，解码和执行单元，所以，当CPU执行第N条指令时，可以对第N+1条指令解码，还可以读取N+2条指令。像这样的组织形式被称为流水线(pipeline)。

除了在嵌入式系统中用的非常简单的CPU之外，多数CPU都有两种模式，即前面提到的内核态和用户态，PSW寄存器中的一个二进制位会控制当前状态是内核态还是用户态。当运行在内核态时，CPU能够执行任何指令集中的指令并且能够使用硬件的功能。在台式机和服务器上，操作系统通常以内核模式运行，从而可以访问完整的硬件。在大多数嵌入式系统中，一部分运行在内核态下，剩下一部分运行在用户态下。

用户应用程序通常运行在用户态下，为了获取操作系统的服务，用户程序必须使用系统调用(system call)，系统调用会转换为内核态并且调用操作系统。TRAP指令用于把用户态切换为内核态并启用操作系统。当有关工作完成之后，在系统调用后面的指令会把控制权交给用户程序。

磁盘(1-4TB)->主存(1-8GB)->高速缓存(4MB)->寄存器(<1KB) 10ms->10ns->2ns->1ns

高速缓存：主存被分割为高速缓存行(cache lines)，为64字节，内存地址的0-63对应高速缓存行0，地址64-127对应高速缓存行的1，有一些机器会有两个或者三个高速缓存级别。L1 cache总是位于CPU内部，用户将已经解码的指令调入CPU的执行引擎。对于哪些频繁使用的关键字，多数芯片有第二个L1 cache，典型的L1 cache的大小为16KB，L2 cache用户存放最近使用过的关键字，一般以兆字节为单位。L1 cache和L2 cache最大的不同在于是否存在延迟。访问L1 cache没有任何延迟。然而访问L2 cache会有1-2个时钟周期的延后。

时钟周期：计算机处理器或CPU的速度由时钟周期来确定，时钟周期是振荡器两个脉冲之间的时间量。例如，一个4GHz处理器每秒执行4，000，000，000个时钟周期。早期的计算机处理器和较慢的CPU每个时钟周期只能执行一条指令。而现代处理器在每个时钟周期可以执行多条指令。

主存：(RAM，Random Access Memory)，ROM(Read Only Memory)

虚拟内存：(MMU，Memory Management Unit)，存储器管理单元

##### 3.IO设备

控制器->硬件设备

任何复杂的东西都可以加一层代理来解决，这是计算机或人类社会很普世的一个解决方案

SATA Serial AT Atachment

##### 4.总线

##### 5.计算机启动过程

在每台计算机上有一块双亲板，也叫母板，主板。主板一般为矩形电路板。上面安装了组成计算机的主要电路系统，一般有BIOS芯片，I/O控制芯片，键盘和面板控制开关接口，指示灯插接件，扩展插槽，主板及插卡的直流电源供电接插件等元件。

在母板上有一个被称为基本输入输出系统(Basic Input Output System，BIOS)的程序。在BIOS内有底层I/O软件，包括读键盘，写屏幕，磁盘I/O以及其他进程，如今，它被保存在闪存中，它是非易失性的，但是当BIOS中发现错误时，可以由操作系统进行更新。

在计算机启动时，BIOS开启，它会首先检查所安装的RAM的数量，键盘和其他基础设备是否已安装并且正常响应。接着，它会扫描PCIe和PCI总线并找出连在上面的所有设备。即插即用的设备也会被记录下来。如果现有的设备和系统上一次启动时的设备不同，则新的设备将被重新配置。之后，BIOS通过尝试存储在CMOS存储器中的设备清单尝试启动设备。

CMOS 互补金属氧化物半导体，是电脑主板上一块可读写的RAM芯片，BIOS设置有时候也被叫做CMOS设置

用户可以在系统启动的时候进入一个BIOS配置程序，对设备清单进行修改。然后，判断是否能够从外部CD-ROM和USB驱动程序启动，如果启动失败的话(也就是没有)，系统将从硬盘启动，boots设备中的第一个扇区被读入内存并执行。该扇区包含一个程序，该程序通常在引导扇区末尾检查分区表以确定哪个分区处于活动状态。然后从该分区读入第二个启动加载程序，该加载器从活动分区中读2取操作系统并启动它。

然后操作系统会询问BIOS获取配置信息，对于每个设备来说，会检查是否有设备驱动程序，一旦有了设备驱动程序，操作系统会把它们加载到内核中，然后初始化表，创建所需的后台进程，并启动登录程序或GUI

#### 二.操作系统概念

##### 1.进程

一个挂起的进程包括：进程的地址空间(往往称作磁心映像)，以及对应的进程表项。

进程间通信

##### 2.地址空间

虚拟内存：操作系统可以把部分地址空间装入主存，部分留在磁盘上，并且在需要时来回交换他们

##### 3.文件

在读写文件之前，首先需要打开文件，检查其访问权限，若权限允许，系统将返回一个小整数，称作文件描述符(file descriptor)，供后续操作使用。若禁止访问，系统则返回一个错误码。

块特殊文件(block special file) & 字符特殊文件(charactor special file)

管道



#### 一.基本特征

##### 1.并发
并发是指宏观上在一段时间内能同时运行多个程序，而并行则指同一时刻能运行多个指令。
并行需要硬件支持，如多流水线、多核处理器或者分布式计算系统
操作系统通过引入进程和线程，使得程序能够并发运行。

##### 2.共享
共享是指系统中的资源可以被多个并发进程共同使用。
有两种共享方式：互斥共享和同时共享。
互斥共享的资源称为临界资源，例如打印机等，在同一时刻只允许一个进程访问，需要用同步机制来实现互斥访问。
##### 3.虚拟
虚拟技术把一个物理实体转换为多个逻辑实体。
主要有两种虚拟技术：时（时间）分复用技术和空（空间）分复用技术。
多个进程能在同一个处理器上并发执行使用了时分复用技术，让每个进程轮流占用处理器，每次只执行一小个时间片并快速切换。
虚拟内存使用了空分复用技术，它将物理内存抽象为地址空间，每个进程都有各自的地址空间。地址空间的页被映射到物理内存，地址空间的页并不需要全部在物理内存中，当使用到一个没有在物理内存的页时，执行页面置换算法，将该页置换到内存中。
##### 4.异步
异步指进程不是一次性执行完毕，而是走走停停，以不可知的速度向前推进。
#### 二.基本功能
##### 1.进程管理
进程控制，进程同步，进程通信，死锁处理，处理机调度等
##### 2.内存管理
内存分配，地址映射，内存保护与共享，虚拟内存等
##### 3.文件管理
文件存储空间的管理，目录管理，文件读写管理和保护等。
##### 4.设备管理
完成用户的I/O请求，方便用户使用各种设备，并提高设备的利用率
主要包括缓冲管理、设备分配、设备处理、虛拟设备等。
#### 三.系统调用
如果一个进程在用户态需要使用内核态的功能，就进行系统调用从而陷入内核，由操作系统代为完成。
![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/tGPV0.png)
Linux系统调用主要有以下这些

| Task     | Commands                    |
| -------- | --------------------------- |
| 进程控制 | fork(); exit(); wait();     |
| 进程通信 | pipe(); shmget(); mmap();   |
| 文件操作 | open(); read(); write();    |
| 设备操作 | ioctl(); read(); write();   |
| 信息维护 | getpid(); alarm(); sleep(); |
| 安全     | chmod(); umask(); chown();  |

#### 四.宏内核与微内核
##### 1. 宏内核

宏内核是将操作系统功能作为一个紧密结合的整体放到内核。

由于各模块共享信息，因此有很高的性能。

##### 2. 微内核

由于操作系统不断复杂，因此将一部分操作系统功能移出内核，从而降低内核的复杂性。移出的部分根据分层的原则划分成若干服务，相互独立。
在微内核结构下，操作系统被划分成小的、定义良好的模块，只有微内核这一个模块运行在内核态，其余模块运行在用户态。
因为需要频繁地在用户态和内核态(也叫管态和核心态)之间进行切换，所以会有一定的性能损失。

![img](https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/2_14_microkernelArchitecture.jpg)

#### 五.中断

##### 1.外中断

由 CPU 执行指令以外的事件引起，如 I/O 完成中断，表示设备输入/输出处理已经完成，处理器能够发送下一个输入/输出请求。此外还有时钟中断、控制台中断等。

##### 2.异常

由 CPU 执行指令的内部事件引起，如非法操作码、地址越界、算术溢出等。

##### 3.陷入

在用户程序中使用系统调用。

#### 六.操作系统面试题

##### 1.进程与线程

###### 1.1.RR算法

###### 1.2.进程间通信(Inter Process Communication,IPC)

```
1.方式:匿名管道，具名管道，共享内存，消息队列，信号量，套接字，信号
2.进程三态模型：运行，阻塞，就绪
```

###### 1.3.调度算法

```
批处理中的调度
1.先来先服务：FIFS(first in, first serve)
2.最短作业优先：SJF(shortest job first)
3.最短剩余时间优先：SRTN(shortest remaining time next)
交互式系统中的调度
1.轮询调度:round-robin
2.优先级调度:priority scheduling 高优先级会被降低
3.最短进程优先:通过当前测量值进行加权平均得到下一个估计值的技术叫做老化
4.彩票调度:lottery scheduling
5.公平分享调度
```

###### 1.4.页面置换算法

##### 2.死锁

```
互斥(Mutual Exclusion):一次只能有一个进程使用资源，如果另一个进程请求该资源，则必须延迟请求进程，直到释放该资源为止。
保持并等待(Hold and Wait):必须存在一个进程，该进程至少持有一个资源，并且正在等待获取其他进程当前所持有的资源
无抢占(No Preemption):资源不能被抢占，也就是说，在进程完成其任务之后，只能由拥有它的进程自动释放资源
循环等待(Circle Wait):必须存在一组{p0,p1,.....,pn}的等待进程，使p0等待p1持有的资源，p1等待由p2持有的资源，pn-1等待由pn持有的资源，而pn正在等待由p0持有的线程
```
